<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SV241 Alpaca Driver Setup</title>
    <!-- Local Fonts -->
    <link rel="stylesheet" href="/static/fonts.css">
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>

    <!-- Removed background-overlay as requested -->

    <div class="container">
        <header class="main-header glass-panel">
            <div class="header-content">
                <h1>SV241 Unbound</h1>
                <span class="subtitle">Alpaca Driver & Controller <span id="proxy-version-display"></span></span>
            </div>
            <div class="header-badges">
                <div class="status-badge" id="com-port-badge">
                    <span class="value">-</span>
                </div>
                <div class="status-badge" id="firmware-badge">
                    <span class="label">FW</span>
                    <span class="value">-</span>
                </div>
                <div class="connection-pill" id="connection-status-pill">
                    <span id="connection-indicator"></span>
                    <span id="connection-text">Connecting...</span>
                </div>
            </div>
        </header>

        <div class="dashboard-grid">
            <!-- Live Status Panel -->
            <div id="live-status" class="glass-panel card full-width">
                <h2>Live Telemetry</h2>
                <div class="status-grid dense-grid">

                    <div class="status-item"><span class="label">Voltage</span><span id="status-v" class="value">-
                            <small>V</small></span></div>
                    <div class="status-item"><span class="label">Current</span><span id="status-i" class="value">-
                            <small>A</small></span></div>
                    <div class="status-item"><span class="label">Power</span><span id="status-p" class="value">-
                            <small>W</small></span></div>
                    <div class="status-item"><span class="label">Amb Temp</span><span id="status-t_amb" class="value">-
                            <small>°C</small></span></div>
                    <div class="status-item"><span class="label">Humidity</span><span id="status-h_amb" class="value">-
                            <small>%</small></span></div>
                    <div class="status-item"><span class="label">Dew Point</span><span id="status-d" class="value">-
                            <small>°C</small></span></div>
                    <div class="status-item"><span class="label">Lens Temp</span><span id="status-t_lens"
                            class="value">-
                            <small>°C</small></span></div>
                    <div class="status-item"><span class="label">PWM 1</span><span id="status-pwm1" class="value">-
                            <small>%</small></span></div>
                    <div class="status-item"><span class="label">PWM 2</span><span id="status-pwm2" class="value">-
                            <small>%</small></span></div>
                </div>
            </div>

            <!-- Power Control Panel -->
            <div id="live-power-control" class="glass-panel card full-width">
                <h2>Power Control</h2>
                <div id="master-switch-container" class="switch-row master-row">
                    <span class="name" id="master-power-label">Master Power</span>
                    <label class="switch-toggle neon-toggle">
                        <input type="checkbox" id="master-power-switch">
                        <span class="slider"></span>
                    </label>
                </div>
                <div id="power-grid" class="power-grid">
                    <!-- Switches will be dynamically inserted here -->
                </div>
            </div>

            <!-- Configuration Section -->
            <div id="config-section" class="glass-panel card full-width">
                <div class="collapsible-header">
                    <h2>Configuration & Settings</h2>
                    <span class="toggle-icon"></span>
                </div>

                <div class="collapsible-content">
                    <div class="tabs">
                        <button class="tab-btn active" data-tab="tab-switches">Switches</button>
                        <button class="tab-btn" data-tab="tab-heaters">Dew Heaters</button>
                        <button class="tab-btn" data-tab="tab-sensors">Sensors</button>
                        <button class="tab-btn" data-tab="tab-system">System</button>
                        <button class="tab-btn" data-tab="tab-proxy">Proxy</button>
                    </div>

                    <div class="tab-content active" id="tab-switches">
                        <div class="config-group full-width-group">
                            <h3>Switch Configuration</h3>
                            <p class="subtitle">Configure switch names, startup states, and visibility. "Disabled"
                                switches are typically hidden from ASCOM and Controls.</p>

                            <div class="table-container">
                                <table class="config-table" id="switch-config-table">
                                    <thead>
                                        <tr>
                                            <th class="th-name">Switch Name</th>
                                            <th class="th-state">State (Startup)</th>
                                            <th class="th-custom">Custom Name</th>
                                            <th class="th-volt">Voltage</th>
                                        </tr>
                                    </thead>
                                    <tbody id="switch-config-tbody">
                                        <!-- Populated by JS -->
                                    </tbody>
                                </table>
                            </div>

                            <button id="save-switch-config-button" class="btn-primary"
                                style="margin-top: 1rem; width: 100%;">Save Switch Configuration</button>
                        </div>
                    </div>

                    <div class="tab-content" id="tab-heaters">
                        <div id="dew-heater-settings">
                            <div class="heater-card">
                                <div id="heater-0">
                                    <h4>Heater 1 (PWM1)</h4>
                                    <div class="form-group"><label><input type="checkbox" id="heater-0-startup-enabled">
                                            Enable on Startup</label>
                                        <input type="text" id="heater-0-custom-name" placeholder="Custom Name"
                                            style="margin-left: 1rem; padding: 0.2rem; border-radius: 4px; border: 1px solid var(--glass-border); background: rgba(255,255,255,0.1); color: var(--text-primary);">
                                    </div>
                                    <div class="form-group">
                                        <label>Mode</label>
                                        <select id="heater-0-mode">
                                            <option value="0">Manual</option>
                                            <option value="1">PID (Lens Sensor)</option>
                                            <option value="2">Ambient Tracking</option>
                                            <option value="3">PID-Sync (Follower)</option>
                                            <option value="4">Minimum Temperature</option>
                                            <option value="5">Disabled</option>
                                        </select>
                                    </div>
                                    <div id="heater-0-mode-0" class="mode-settings"><label>Power (%)</label><input
                                            type="number" id="heater-0-manual-power" min="0" max="100"></div>
                                    <div id="heater-0-mode-1" class="mode-settings">
                                        <label>Target Offset (°C)</label><input type="number"
                                            id="heater-0-target-offset" step="0.1">
                                        <div class="pid-grid">
                                            <label>Kp <input type="number" id="heater-0-pid-kp" step="0.1"></label>
                                            <label>Ki <input type="number" id="heater-0-pid-ki" step="0.1"></label>
                                            <label>Kd <input type="number" id="heater-0-pid-kd" step="0.1"></label>
                                        </div>
                                    </div>
                                    <div id="heater-0-mode-2" class="mode-settings">
                                        <label>Start Delta (°C)</label><input type="number" id="heater-0-start-delta"
                                            step="0.1">
                                        <label>End Delta (°C)</label><input type="number" id="heater-0-end-delta"
                                            step="0.1">
                                        <label>Max Power (%)</label><input type="number" id="heater-0-max-power" min="0"
                                            max="100">
                                    </div>
                                    <div id="heater-0-mode-3" class="mode-settings">
                                        <label>Sync Factor</label><input type="number" id="heater-0-pid-sync-factor"
                                            step="0.1" min="0" max="2.0">
                                        <label><input type="checkbox" id="heater-0-auto-enable-leader"> Auto-enable PID
                                            Leader</label>
                                    </div>
                                    <div id="heater-0-mode-4" class="mode-settings">
                                        <label>Min Temp (°C)</label><input type="number" id="heater-0-min-temp"
                                            step="0.1">
                                        <label>Target Offset (°C)</label><input type="number"
                                            id="heater-0-target-offset-4" step="0.1">
                                        <div class="pid-grid">
                                            <label>Kp <input type="number" id="heater-0-pid-kp-4" step="0.1"></label>
                                            <label>Ki <input type="number" id="heater-0-pid-ki-4" step="0.1"></label>
                                            <label>Kd <input type="number" id="heater-0-pid-kd-4" step="0.1"></label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="heater-card">
                                <div id="heater-1">
                                    <h4>Heater 2 (PWM2)</h4>
                                    <div class="form-group"><label><input type="checkbox" id="heater-1-startup-enabled">
                                            Enable on Startup</label>
                                        <input type="text" id="heater-1-custom-name" placeholder="Custom Name"
                                            style="margin-left: 1rem; padding: 0.2rem; border-radius: 4px; border: 1px solid var(--glass-border); background: rgba(255,255,255,0.1); color: var(--text-primary);">
                                    </div>
                                    <div class="form-group">
                                        <label>Mode</label>
                                        <select id="heater-1-mode">
                                            <option value="0">Manual</option>
                                            <option value="1">PID (Lens Sensor)</option>
                                            <option value="2">Ambient Tracking</option>
                                            <option value="3">PID-Sync (Follower)</option>
                                            <option value="4">Minimum Temperature</option>
                                            <option value="5">Disabled</option>
                                        </select>
                                    </div>
                                    <div id="heater-1-mode-0" class="mode-settings"><label>Power (%)</label><input
                                            type="number" id="heater-1-manual-power" min="0" max="100"></div>
                                    <div id="heater-1-mode-1" class="mode-settings">
                                        <label>Target Offset (°C)</label><input type="number"
                                            id="heater-1-target-offset" step="0.1">
                                        <div class="pid-grid">
                                            <label>Kp <input type="number" id="heater-1-pid-kp" step="0.1"></label>
                                            <label>Ki <input type="number" id="heater-1-pid-ki" step="0.1"></label>
                                            <label>Kd <input type="number" id="heater-1-pid-kd" step="0.1"></label>
                                        </div>
                                    </div>
                                    <div id="heater-1-mode-2" class="mode-settings">
                                        <label>Start Delta (°C)</label><input type="number" id="heater-1-start-delta"
                                            step="0.1">
                                        <label>End Delta (°C)</label><input type="number" id="heater-1-end-delta"
                                            step="0.1">
                                        <label>Max Power (%)</label><input type="number" id="heater-1-max-power" min="0"
                                            max="100">
                                    </div>
                                    <div id="heater-1-mode-3" class="mode-settings">
                                        <label>Sync Factor</label><input type="number" id="heater-1-pid-sync-factor"
                                            step="0.1" min="0" max="2.0">
                                        <label><input type="checkbox" id="heater-1-auto-enable-leader"> Auto-enable PID
                                            Leader</label>
                                    </div>
                                    <div id="heater-1-mode-4" class="mode-settings">
                                        <label>Min Temp (°C)</label><input type="number" id="heater-1-min-temp"
                                            step="0.1">
                                        <label>Target Offset (°C)</label><input type="number"
                                            id="heater-1-target-offset-4" step="0.1">
                                        <div class="pid-grid">
                                            <label>Kp <input type="number" id="heater-1-pid-kp-4" step="0.1"></label>
                                            <label>Ki <input type="number" id="heater-1-pid-ki-4" step="0.1"></label>
                                            <label>Kd <input type="number" id="heater-1-pid-kd-4" step="0.1"></label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button class="save-config-button btn-primary" style="width: 100%; margin-top: 1rem;">Save
                            Heater Settings</button>
                    </div>

                    <div class="tab-content" id="tab-sensors">
                        <div id="sensor-settings-group">
                            <div class="sensor-grid-settings">
                                <div class="settings-block">
                                    <h4>Offsets</h4>
                                    <label>SHT40 Temp Offset <input type="number" id="offset-sht40-temp"
                                            step="0.1"></label>
                                    <label>SHT40 Hum Offset <input type="number" id="offset-sht40-humidity"
                                            step="0.1"></label>
                                    <label>DS18B20 Temp Offset <input type="number" id="offset-ds18b20-temp"
                                            step="0.1"></label>
                                    <label>Voltage Offset <input type="number" id="offset-ina219-voltage"
                                            step="0.01"></label>
                                    <label>Current Offset <input type="number" id="offset-ina219-current"
                                            step="0.1"></label>
                                </div>
                                <div class="settings-block">
                                    <h4>Averaging</h4>
                                    <label>SHT40 Temp <input type="number" id="avg-sht40-temp" min="1" max="20"></label>
                                    <label>SHT40 Hum <input type="number" id="avg-sht40-humidity" min="1"
                                            max="20"></label>
                                    <label>DS18B20 Temp <input type="number" id="avg-ds18b20-temp" min="1"
                                            max="20"></label>
                                    <label>Voltage <input type="number" id="avg-ina219-voltage" min="1"
                                            max="20"></label>
                                    <label>Current <input type="number" id="avg-ina219-current" min="1"
                                            max="20"></label>
                                </div>
                                <div class="settings-block">
                                    <h4>Intervals (ms)</h4>
                                    <label>Power <input type="number" id="interval-ina219" step="100"></label>
                                    <label>Ambient <input type="number" id="interval-sht40" step="100"></label>
                                    <label>Lens <input type="number" id="interval-ds18b20" step="100"></label>
                                </div>
                            </div>
                            <button class="save-config-button btn-primary" style="margin-top: 1rem;">Save Sensor
                                Settings</button>

                            <div class="settings-block" style="margin-top: 1.5rem;">
                                <h4>SHT40 Auto-Drying</h4>
                                <div class="form-group"><label><input type="checkbox" id="auto-dry-enabled"> Enable
                                        Auto-Drying</label></div>
                                <div class="pid-grid">
                                    <label>Trigger > % <input type="number" id="auto-dry-humidity-threshold" min="50"
                                            max="100"></label>
                                    <label>Duration (s) <input type="number" id="auto-dry-trigger-duration" min="10"
                                            max="600"></label>
                                </div>
                                <button class="save-config-button btn-primary">Save Auto-Drying</button>
                            </div>
                        </div>
                    </div>

                    <div class="tab-content" id="tab-system">
                        <div class="settings-block">
                            <h4>Manual Actions</h4>
                            <button id="manual-dry-sensor-button" class="btn-secondary">Trigger Sensor Drying
                                Cycle</button>
                        </div>
                        <div class="settings-block">
                            <h4>Backup & Restore</h4>
                            <div class="button-row">
                                <button id="backup-button" class="btn-secondary">Create Backup</button>
                                <button id="restore-button" class="btn-secondary">Restore Backup</button>
                                <input type="file" id="restore-file-input" accept=".json" style="display: none;">
                            </div>
                        </div>
                        <div class="settings-block danger-zone">
                            <h4>Danger Zone</h4>
                            <div class="button-row">
                                <button id="reboot-button" class="btn-danger">Reboot Device</button>
                                <button id="factory-reset-button" class="btn-danger">Factory Reset</button>
                            </div>
                        </div>
                    </div>

                    <div class="tab-content" id="tab-proxy">
                        <div class="settings-block">
                            <h4>Connection</h4>
                            <div class="form-group">
                                <label>Serial Port Name</label>
                                <input type="text" id="proxy-serial-port" placeholder="Auto-detect">
                            </div>
                            <div class="form-group"><label><input type="checkbox" id="proxy-auto-detect-port">
                                    Auto-detect Port</label></div>

                            <div class="pid-grid">
                                <label>Listen Address
                                    <select id="proxy-listen-address">
                                        <!-- Options will be populated by JavaScript -->
                                    </select>
                                </label>
                                <label>Port <input type="number" id="proxy-network-port" min="1024" max="65535"></label>
                                <label>Log Level
                                    <select id="proxy-log-level">
                                        <option value="DEBUG">Debug</option>
                                        <option value="INFO">Info</option>
                                        <option value="WARN">Warning</option>
                                        <option value="ERROR">Error</option>
                                    </select>
                                </label>
                                <label>Keep Telemetry (Nights) <input type="number" id="proxy-history-retention" min="1"
                                        max="365"></label>
                            </div>
                        </div>

                        <div class="settings-block">
                            <h4>Alpaca Features & Switches</h4>
                            <div class="form-group"><label><input type="checkbox" id="proxy-enable-alpaca-voltage">
                                    Enable Alpaca Voltage Control (0-15V Slider)</label></div>

                            <div class="form-group">
                                <label>Master Power Switch (Virtual)</label>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <select id="proxy-master-power-state" class="theme-select"
                                        style="width: auto; min-width: 120px;">
                                        <option value="enabled">Enabled</option>
                                        <option value="disabled">Disabled</option>
                                    </select>
                                    <input type="text" id="proxy-master-power-name" placeholder="Switch Name"
                                        style="flex: 1;">
                                </div>
                                <small style="display: block; margin-top: 0.3rem; color: var(--text-muted);">
                                    When disabled, this switch is hidden from ASCOM clients.
                                </small>
                            </div>
                        </div>

                        <div class="settings-block">
                            <button id="save-proxy-config-button" class="btn-primary" style="width: 100%;">Save Proxy
                                Config</button>
                        </div>
                    </div>

                </div>

            </div> <!-- End config-section -->

            <!-- Log Viewer -->
            <div id="live-log-viewer" class="glass-panel card full-width">
                <div class="collapsible-header">
                    <h2>Live Log</h2>
                    <span class="toggle-icon"></span>
                </div>
                <div class="collapsible-content">
                    <pre id="log-container"></pre>
                </div>
            </div>

        </div> <!-- End dashboard-grid -->
    </div> <!-- End container -->

    <!-- Chart.js Libraries -->
    <script src="/static/chart.umd.js" defer></script>
    <script src="/static/chartjs-adapter-date-fns.bundle.min.js" defer></script>
    <script src="/static/hammer.min.js" defer></script>
    <script src="/static/chartjs-plugin-zoom.min.js" defer></script>
    <script src="/static/app.js" defer></script>

    <!-- Telemetry Modal -->
    <div id="telemetry-modal" class="modal-overlay hidden">
        <div class="modal-content glass-panel"
            style="width: 90%; max-width: 1200px; height: 90vh; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h2 id="telemetry-modal-title">Telemetry History</h2>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <select id="telemetry-date-select" class="theme-select">
                        <option value="">Current & Previous Night</option>
                    </select>
                    <button id="close-telemetry-modal" class="close-btn">&times;</button>
                </div>
            </div>
            <div class="modal-body" style="flex: 1; min-height: 0; position: relative;">
                <canvas id="telemetry-chart"></canvas>
            </div>
            <div class="modal-footer"
                style="padding: 0.5rem; text-align: center; font-size: 0.8rem; color: var(--text-muted);">
                Scan/Pinch to Zoom, Drag to Pan. Double-click to Reset Zoom.
            </div>
        </div>
    </div>
    <!-- Generic Confirmation Modal -->
    <div id="confirmation-modal" class="modal-overlay hidden">
        <div class="modal-content glass-panel" style="width: 90%; max-width: 500px; text-align: center;">
            <div class="modal-header">
                <h2 id="confirm-modal-title">Confirmation</h2>
                <button class="close-btn" onclick="closeModal('confirmation-modal')">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1rem 0;">
                <p id="confirm-modal-message"
                    style="font-size: 1.1rem; color: var(--text-primary); margin-bottom: 2rem;">Are you sure?</p>
                <div class="button-row" style="justify-content: center; gap: 1rem;">
                    <button id="confirm-modal-ok" class="btn-primary">Yes, Proceed</button>
                    <button id="confirm-modal-cancel" class="btn-secondary"
                        onclick="closeModal('confirmation-modal')">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Generic Alert Modal -->
    <div id="alert-modal" class="modal-overlay hidden">
        <div class="modal-content glass-panel" style="width: 90%; max-width: 400px; text-align: center;">
            <div class="modal-header">
                <h2 id="alert-modal-title">Info</h2>
                <button class="close-btn" onclick="closeModal('alert-modal')">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1rem 0;">
                <p id="alert-modal-message" style="font-size: 1.1rem; color: var(--text-primary); margin-bottom: 2rem;">
                    Information</p>
                <button class="btn-primary" onclick="closeModal('alert-modal')">OK</button>
            </div>
        </div>
    </div>
</body>

</html>